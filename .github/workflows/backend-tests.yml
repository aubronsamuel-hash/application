name: Codex CI / backend-tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
      - name: Run pytest with coverage
        run: pytest backend
      - name: Coverage gate >= 70%
        run: |
          python - <<'PY'
          import xml.etree.ElementTree as ET

          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          coverage = float(root.get('line-rate', '0')) * 100
          print(f'Backend coverage: {coverage:.2f}%')
          if coverage < 70.0:
              raise SystemExit(1)
          PY
